{% extends 'sentia/base.html' %}

{% block title %}Dashboard | Sent.IA{% endblock %}

{% block content %}
{% if messages %}
    {% for message in messages %}
    <div class="alert alert-success alert-dismissible fade show mb-4" role="alert">
        <i class="fa-solid fa-circle-check me-2"></i>{{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
{% endif %}


<div class="card shadow mb-4">
    <div class="card-header bg-light">
        <h5 class="card-title mb-0">
            <i class="fa-solid fa-filter me-2"></i>Filtros
        </h5>
    </div>
    <div class="card-body">
        <form method="GET" action="{% url 'dashboard' %}" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label for="sessionFilter" class="form-label">Sessão de Análise</label>
                <select class="form-select" id="sessionFilter" name="session">
                    <option value="">Todas as Sessões</option>
                    {% for session in all_sessions %}
                        <option value="{{ session.id }}" {% if selected_session_id|slugify == session.id|slugify %}selected{% endif %}>
                            {{ session }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-3">
                <label for="sentimentFilter" class="form-label">Sentimento</label>
                <select class="form-select" id="sentimentFilter" name="sentiment">
                    <option value="">Todos</option>
                    {% for choice_value, choice_label in sentiment_choices %}
                        <option value="{{ choice_value }}" {% if selected_sentiment == choice_value %}selected{% endif %}>
                            {{ choice_label }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-4">
                <label for="productAreaFilter" class="form-label">Área do Produto</label>
                <select class="form-select" id="productAreaFilter" name="product_area">
                    <option value="">Todas as Áreas</option>
                    {% for area in all_product_areas %}
                        <option value="{{ area }}" {% if selected_product_area == area %}selected{% endif %}>
                            {{ area }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-2 d-grid">
                <button type="submit" class="btn btn-primary">
                    <i class="fa-solid fa-filter me-1"></i>Aplicar Filtros
                </button>
            </div>
        </form>
    </div>
</div>

<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card text-center shadow h-100">
            <div class="card-body">
                <h6 class="card-title text-muted">Total de Feedbacks</h6>
                <h3 class="card-text">{{ stats.total }}</h3>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card text-center shadow border-success h-100">
            <div class="card-body">
                <h6 class="card-title text-muted">Positivos</h6>
                <h3 class="card-text text-success">{{ stats.positive }}</h3>
                <p class="card-text text-success mb-0">{{ stats.positive_percent|floatformat:1 }}%</p>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card text-center shadow border-danger h-100">
            <div class="card-body">
                <h6 class="card-title text-muted">Negativos</h6>
                <h3 class="card-text text-danger">{{ stats.negative }}</h3>
                <p class="card-text text-danger mb-0">{{ stats.negative_percent|floatformat:1 }}%</p>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card text-center shadow border-secondary h-100">
            <div class="card-body">
                <h6 class="card-title text-muted">Neutros</h6>
                <h3 class="card-text text-secondary">{{ stats.neutral }}</h3>
                <p class="card-text text-secondary mb-0">{{ stats.neutral_percent|floatformat:1 }}%</p>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-lg-6 mb-4">
        <div class="card shadow h-100">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">
                    <i class="fa-solid fa-chart-pie me-2"></i>Distribuição de Sentimentos
                </h5>
            </div>
            <div class="card-body d-flex justify-content-center align-items-center">
                <canvas id="sentimentChart" style="max-height: 300px;"></canvas>
            </div>
        </div>
    </div>

    <div class="col-lg-6 mb-4">
        <div class="card shadow h-100">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">
                    <i class="fa-solid fa-history me-2"></i>Sessões de Análise
                </h5>
            </div>
            <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead>
                            <tr>
                                <th class="ps-3">Sessão</th>
                                <th>Arquivo CSV</th>
                                <th>Data da Análise</th>
                                <th class="text-end pe-3">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for session in all_sessions %}
                            <tr>
                                <td class="ps-3"><a href="?session={{ session.id }}">#{{ session.session_number }}</a></td>
                                <td>{{ session.csv_filename|default:"N/A" }}</td>
                                <td>{{ session.created_at|date:"d/m/Y H:i" }}</td>
                                <td class="text-end pe-3">
                                    <form method="POST" action="{% url 'delete_session' session.id %}" class="d-inline">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Tem certeza que deseja excluir esta sessão?')">
                                            <i class="fa-solid fa-trash"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center p-4">Nenhuma sessão encontrada.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card shadow">
    <div class="card-header bg-light">
        <h5 class="card-title mb-0">
            <i class="fa-solid fa-comments me-2"></i>Feedbacks Analisados
        </h5>
    </div>
    <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead>
                    <tr>
                        <th class="ps-3">Feedback</th>
                        <th>Sentimento</th>
                        <th>Cliente</th>
                        <th>Data Feedback</th>
                        <th>Área Produto</th>
                        <th>Sessão</th>
                        <th class="pe-3">Analisado em</th>
                    </tr>
                </thead>
                <tbody>
                    {% for feedback in all_feedbacks %}
                    <tr>
                        <td class="ps-3">{{ feedback.text|truncatechars:70 }}</td>
                        <td>
                            {% if feedback.sentiment == 'POS' %}
                                <span class="badge bg-success-subtle text-success-emphasis rounded-pill">Positivo</span>
                            {% elif feedback.sentiment == 'NEG' %}
                                <span class="badge bg-danger-subtle text-danger-emphasis rounded-pill">Negativo</span>
                            {% elif feedback.sentiment == 'NEU' %}
                                <span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill">Neutro</span>
                            {% else %}
                                 <span class="badge bg-warning-subtle text-warning-emphasis rounded-pill">Desconhecido</span>
                            {% endif %}
                        </td>
                        <td>{{ feedback.customer_name|default:"N/A" }}</td>
                        <td>{{ feedback.feedback_date|date:"d/m/Y"|default:"N/A" }}</td>
                        <td>{{ feedback.product_area|default:"N/A" }}</td>
                        <td><a href="?session={{ feedback.session.id }}">#{{ feedback.session.session_number }}</a></td>
                        <td class="pe-3">{{ feedback.created_at|date:"d/m/Y H:i" }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center p-4">Nenhum feedback encontrado com os filtros aplicados.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{{ stats|json_script:"chart-data" }}

{% endblock %}


{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const statsData = JSON.parse(document.getElementById('chart-data').textContent);
        
        const ctx = document.getElementById('sentimentChart').getContext('2d');
        const sentimentChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Positivos', 'Negativos', 'Neutros', 'Desconhecidos'],
                datasets: [{
                    data: [
                        statsData.positive || 0,
                        statsData.negative || 0,
                        statsData.neutral || 0,
                        statsData.unknown || 0
                    ],
                    backgroundColor: [
                        'rgba(25, 135, 84, 0.8)',
                        'rgba(220, 53, 69, 0.8)',
                        'rgba(108, 117, 125, 0.8)',
                        'rgba(255, 193, 7, 0.8)'
                    ],
                    borderColor: [
                        '#ffffff'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    });
</script>
{% endblock %}